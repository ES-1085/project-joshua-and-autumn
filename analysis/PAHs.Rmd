---
title: 'GOM Contaminated Sediments analysis: PAHs'
author: "Joshua Harkness and Autumn Pauly"
date: "2023-10-28"
output: github_document
---

```{r load-packages}
library(tidyverse)
library(sf)
library(leaflet)
library(ggplot2)
library(RColorBrewer)

```

#Loading data
```{r load-data}
#PAHs <- read.csv(paste0("/cloud/project/data/datasets_csv/PAHs_loc.csv"), header = T)

PAHs <- PAHs_loc
```

#Glimpsing PAH
```{r glimpse-data, warning=FALSE}
glimpse(PAHs)
```

# Joining the Station Information to the PAH dataset
```{r joining-station-info, warning=FALSE}

PAHs_station <- full_join(Station2002, PAHs, by = "UNIQUE_ID")

PAHs_station <- PAHs_station %>%
  mutate(CHRYSENE_C = as.numeric(CHRYSENE_C)) %>%
  pivot_longer(cols = `BENZNE_C`:`B_GHI_PYLC`, 
               names_to = "pah_detected", 
               values_to = "amount_detected")

PAHs_station = select(PAHs_station, c(UNIQUE_ID, LATITUDE.x, LONGITUDE.x, SOUNDING_M.x, QUAD_NAME.x, GEN_LOC_NM.x, SPECFC_LOC.x, AREA_CODE.x, SAMP_DATE1.x, TO_SMP_DT2.x, DPTH_N_COR.x, DPTH_CODE.x, COR_GRB_CD.x, site.x, pah_detected, amount_detected))

glimpse(PAHs_station)

```
Joining the station data with the PAH sample taken. The dataset is pivoted so that each observation is the PAH that was observed.

# Plotting PAHs Detected in GOM
``` {r plotting-pahs-detected, warning=FALSE}

#PAHs_station %>%
 # filter(pah_detected %in% c("BENZNE_C", "BENZNE_C", "NAPHTHLN_C", "BIPHENYL_C", "ACNPHTHN_C", "ACNPHTYL_C", "FLUORENE_C", "PHNANTHR_C", "ANTHRACN_C", "PYRENE_C", "FLORNTHN_C", "CHRYSENE_C", "PERYLENE_C")) %>%
  #ggplot(aes(x = pah_detected, y = amount_detected, color = pah_detected)) +
  #geom_col() + 
  #theme(axis.text.x = element_text(angle = 90, hjust = 1))

#I do now know why it is colored like that

```

``` {r plotting-names-test}

PAHs_station %>%
  ggplot(aes(x = LONGITUDE.x, y = LATITUDE.x, color = GEN_LOC_NM.x)) + 
  geom_point()

```

``` {r summary-stats-PAHs}
Summary_PAHs <- PAHs_station %>%
  group_by(GEN_LOC_NM.x) %>%
  drop_na(amount_detected) %>%
  summarise(mean_PAH = mean(amount_detected),
    sd_PAH = sd(amount_detected),
    n_PAH = n(),
    SE_PAH = sd(amount_detected) / sqrt(n()))

Summary_PAHs

```

``` {r pah-gen-loc}
Summary_PAHs %>%
  ggplot(aes(x = fct_rev(fct_reorder(GEN_LOC_NM.x, mean_PAH)), y = mean_PAH, fill = GEN_LOC_NM.x))+
  geom_col(col = "black")+
  geom_errorbar(aes(ymin = mean_PAH - SE_PAH, ymax = mean_PAH + SE_PAH), width = 0.2)+
  coord_flip()+
  scale_fill_viridis_d()+
  theme_bw()+
  theme(legend.position = "none")+
  labs(title = "PAH Concentrations in Gulf of Maine Sediments",
       x = "General location",
       y = "Mean total PAH concentration ng/g",
       caption = "Error bars = 1 standard error")
```

```{r pah-boston-harbor1}
Summary_PAHs %>%
  filter(GEN_LOC_NM.x %in% c("BOSTON INNER HARBOR", "CENTRAL BOSTON HARBOR", "SOUTHEAST BOSTON HARBOR", "NORTHWEST BOSTON HARBOR")) %>%
  ggplot(aes(x = fct_rev(fct_reorder(GEN_LOC_NM.x, mean_PAH)), y = mean_PAH, fill = GEN_LOC_NM.x))+
  geom_col(col = "black")+
  geom_errorbar(aes(ymin = mean_PAH - SE_PAH, ymax = mean_PAH + SE_PAH), width = 0.2)+
  scale_fill_brewer(type = "qual", palette = 4, direction = 1, aesthetics = "fill")+
  theme_bw()+
  coord_flip()+
  theme(legend.position = "none")+
  labs(title = "PAH Concentrations in Boston Harbor Sediments",
       x = "General location",
       y = "Mean total PAH concentration ng/g",
       caption = "Error bars = 1 standard error")
```

```{r pah-boston-harbor2}
Summary_PAHs %>%
  filter(GEN_LOC_NM.x %in% c("CENTRAL BOSTON HARBOR", "NORTHWEST BOSTON HARBOR")) %>%
  ggplot(aes(x = fct_reorder(GEN_LOC_NM.x, mean_PAH), y = mean_PAH, fill = GEN_LOC_NM.x))+
  geom_col(col = "black")+
  geom_errorbar(aes(ymin = mean_PAH - SE_PAH, ymax = mean_PAH + SE_PAH), width = 0.2)+
  scale_fill_brewer(type = "qual", palette = 4, direction = 1, aesthetics = "fill")+
  theme_bw()+
  theme(legend.position = "none")+
  labs(title = "PAH Concentrations in Boston Harbor Sediments",
       subtitle = "Central and Northwest Boston Harbor",
       x = "General location",
       y = "Mean total PCB concentration ng/g",
       caption = "Error bars = 1 standard error")
```
``` {r facet-by-site}
PAHs_station %>%
  filter(GEN_LOC_NM.x %in% c("BOSTON INNER HARBOR", "CENTRAL BOSTON HARBOR", "SOUTHEAST BOSTON HARBOR", "NORTHWEST BOSTON HARBOR")) %>%
  ggplot(aes(x = GEN_LOC_NM.x, y = amount_detected, fill = GEN_LOC_NM.x))+
  facet_wrap(.~pah_detected) +
  scale_fill_brewer(type = "qual", palette = 4, direction = 1, aesthetics = "fill")+
  theme_bw()+
  coord_flip()+
  theme(legend.position = "none")+
  labs(title = "PAH Concentrations in Boston Harbor Sediments",
       x = "General location",
       y = "Mean total PAH concentration ng/g")
```


### Specific Locations

```{r}
Sum_PAH_site <- PAHs_station %>%
  group_by(site.x) %>%
  drop_na(amount_detected) %>%
  summarise(mean_PAH = mean(amount_detected),
    sd_PAH = sd(amount_detected),
    n_PAH = n(),
    SE_PAH = sd(amount_detected) / sqrt(n()))

Sum_PAH_site
```

```{r pah-concentrations-in-me-rivers}
Sum_PAH_site2 <- Sum_PAH_site %>% 
  filter(site.x == c("Kennebunk River", "MYSTIC RIVER", "Mystic Rvr, red nun 4", "Neponset River", "Neponset River mouth", "Portland Fore River", "Royal River", "Weymouth Back River", "York River", "Weymouth Fore River", "Weymouth Fore Rvr", "Piscataqua River N of Pierce Is.", "NORTH RIVER", "Neponset River Bridge", "Charles River"))

Sum_PAH_site2 %>%
  ggplot(aes(x = site.x, y = mean_PAH))+
  geom_bar(stat="identity", col = "black")+
  scale_x_discrete(drop=FALSE)+
  geom_errorbar(aes(ymin = mean_PAH - SE_PAH, ymax = mean_PAH + SE_PAH), width = 0.2)+
  scale_fill_brewer(type = "qual", palette = 4, direction = 1, aesthetics = "fill")+
  theme_bw()+
  coord_flip()+
  theme(legend.position = "none")+
  labs(title = "PAH Concentrations in Maine Rivers",
       subtitle = "Union River excluded",
       caption = "Error bars = 1 standard error",
       x = "Location",
       y = "Mean total PAH concentration ng/g")
```
Why won't the graph only show the river areas? Why is it showing all?

## Statistical tests
### Difference between general locations

Does total PAH concentration differ significantly between general locations?

```{r}
hist(PAHs_station$amount_detected)
```

```{r}
kw1=kruskal.test(PAHs_station$amount_detected ~ PAHs_station$GEN_LOC_NM.x)
kw1
```
This shows that it is significant. We will now run a Dunn post-hoc test to identify any significance between locations.
```{r}
#install.packages("dunn.test")
library(dunn.test)

dunn=dunn.test(PAHs_station$amount_detected,Organics$GEN_LOC_NM.x,method="bh")

```
Interpretation: Most general locations have significantly different mean total PAH concentrations.

## Map Plots
### Static maps
```{r load-GOM_states-shp}
GOM_states <- st_read("/cloud/project/extra/GOM_DD.shp")
```

```{r load-bathy-shp}
Bathy <- st_read("/cloud/project/extra/BATHYMGM_ARC.shp")
```
Bathymetry data is in projected coordinate system (NAD83), other data is geodetic (NAD83).  
Wasn't able to add this layer to map plot -- need to change projection.

```{r bathy-to-NAD83-format}
st_crs(Bathy)
Bathy <- st_transform(Bathy, "+init=epsg:4269")
```
Now the Bathy shapefile is in geodetic NAD83 format.

```{r unique-bathy}
unique(Bathy$CONTOUR)
```

```{r plot-bathy}
Bathy_low_res <- Bathy%>%
 filter(CONTOUR %in% c("-100","-500","-1000","-2000","-3000","-4000"))
ggplot(Bathy_low_res) +
  geom_sf(aes())
```
```{r creating-Bathy_hi_res-pah}
Bathy_hi_res <- Bathy%>%
 filter(CONTOUR %in% c("-40","-80","-120","160","200","240"))
ggplot(Bathy_hi_res) +
  geom_sf(aes())
```

```{r drop-na-pah}
PAH_no_na <- PAHs_station %>%
  drop_na(amount_detected)

PAH_no_na_specific_pah <- PAH_no_na %>%
  filter(pah_detected %in% c("BENZNE_C", "BENZNE_C", "NAPHTHLN_C", "BIPHENYL_C", "ACNPHTHN_C", "ACNPHTYL_C", "FLUORENE_C", "PHNANTHR_C", "ANTHRACN_C", "PYRENE_C", "FLORNTHN_C", "CHRYSENE_C", "PERYLENE_C"))

```


```{r pah-gom-map-plot, warning = FALSE}
ggplot(GOM_states)+
  geom_sf(aes())+
  geom_sf(data = Bathy_low_res, color = "gray80", width = 1)+
  geom_point(data = PAH_no_na, (aes(x = LONGITUDE.x, y = LATITUDE.x, size = amount_detected, alpha = 0.5)))+
  xlim(-72,-65)+
  ylim(40,45)+
  theme_bw()+
  labs(title = "Distribution and concentration of PAHs",
       subtitle ="Gulf of Maine sediments",
       x = "Longitude",
       y = "Latitude")+
  guides(size = guide_legend(title = "PAH ng/g"))+
  guides(alpha = FALSE)+
  ggspatial::annotation_scale(
    location = "bl",
    bar_cols = c("grey60", "white"),
    text_family = "ArcherPro Book"
  ) +
  ggspatial::annotation_north_arrow(
    location = "tr", which_north = "true",
    pad_x = unit(0, "in"), pad_y = unit(0.2, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20",
      text_family = "ArcherPro Book"))
```
Above is the Distribution and concentration of PAHs in the Gulf of Maine sediments. 

```{r MDI-area-map-pah}
ggplot(GOM_states)+
  geom_sf(aes())+
  geom_sf(data = Bathy_hi_res, color = "gray80", width = 1)+
  geom_point(data=PAH_no_na, (aes(x = LONGITUDE.x, y = LATITUDE.x, size = amount_detected, alpha = 0.5)))+
  xlim(-69.2,-68)+
  ylim(44,44.5)+
  theme_bw()+
  labs(title = "Distribution and concentration of PAHs",
       subtitle ="MDI and Penobscot Bay sediments",
       x = "Longitude",
       y = "Latitude")+
  guides(size = guide_legend(title = "PAH ng/g"))+
  guides(alpha = FALSE)+
  ggspatial::annotation_scale(
    location = "bl",
    bar_cols = c("grey60", "white"),
    text_family = "ArcherPro Book"
  ) +
  ggspatial::annotation_north_arrow(
    location = "tr", which_north = "true",
    pad_x = unit(0, "in"), pad_y = unit(0.2, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20",
      text_family = "ArcherPro Book"))
```
Above is the Distribution and concentration of PAHs in MDI and Penobscot Bay sediments. 

```{r boston-and-ma-area-map-pah}
ggplot(GOM_states)+
  geom_sf(aes())+
  geom_sf(data = Bathy_hi_res, color = "gray80", width = 1)+
  geom_point(data=PAH_no_na, (aes(x = LONGITUDE.x, y = LATITUDE.x, size = amount_detected, alpha = 0.5)))+
  xlim(-71.2,-69.5)+
  ylim(41.8,43)+
  theme_bw()+
  labs(title = "Distribution and concentration of PAHs",
       subtitle ="Boston, MA and Cape Cod Bay sediments",
       x = "Longitude",
       y = "Latitude")+
  guides(size = guide_legend(title = "PAH ng/g"))+
  guides(alpha = FALSE)+
  ggspatial::annotation_scale(
    location = "bl",
    bar_cols = c("grey60", "white"),
    text_family = "ArcherPro Book"
  ) +
  ggspatial::annotation_north_arrow(
    location = "tr", which_north = "true",
    pad_x = unit(0, "in"), pad_y = unit(0.1, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20",
      text_family = "ArcherPro Book"))
```
Above is the Distribution and concentration of PAHs in Boston, MA and Cape Cod Bay sediments. 

```{r boston-and-ma-area-map-pah}
ggplot(GOM_states)+
  geom_sf(aes())+
  geom_sf(data = Bathy_hi_res, color = "gray80", width = 1)+
  geom_point(data=PAH_no_na_specific_pah, (aes(x = LONGITUDE.x, y = LATITUDE.x, size = amount_detected, color = pah_detected, alpha = 0.5)))+
  xlim(-71.2,-69.5)+
  ylim(41.8,43)+
  theme_bw()+
  labs(title = "Distribution and concentration of PAHs",
       subtitle ="Boston, MA and Cape Cod Bay sediments",
       x = "Longitude",
       y = "Latitude")+
  guides(size = guide_legend(title = "PAH ng/g"))+
  guides(alpha = FALSE)+
  ggspatial::annotation_scale(
    location = "bl",
    bar_cols = c("grey60", "white"),
    text_family = "ArcherPro Book"
  ) +
  ggspatial::annotation_north_arrow(
    location = "tr", which_north = "true",
    pad_x = unit(0, "in"), pad_y = unit(0.1, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20",
      text_family = "ArcherPro Book"))
```
Above is the same graph, but now we are coloring the points by the specific pah that was detected. 

### Interactive map

```{r create-html-labels-pah}
#labels <- sprintf("<strong>%s</strong><br/>%g ng/g", 
#                 PAH_no_na$SPECFC_LOC.x, PAH_no_na$amount_detected) %>%
# lapply(htmltools::HTML)
#
#head(labels, 1)
```

```{r leaflet-map-pcb}
#leaflet(data = PAH_no_na) %>%
  #addProviderTiles(providers$Esri.WorldTopoMap) %>%
  #setView(lng = -68.5, 
    #      lat = 43.5, 
     #     zoom = 6) %>%
  #addCircleMarkers(lng = ~LONGITUDE.x, lat = ~LATITUDE.x, popup = c(~SPECFC_LOC.x, ~amount_detected), label = labels)
```

Note that the two above code chunks are commented out as .rmd will not knit to github document with html functions.  Uncomment to run and change output type to `html_document` to knit.


